<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Boundless Vision: Gestão PPC e Force-Directed Graph | Casa Estoril</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a;
            --sidebar-bg: rgba(10, 15, 25, 0.95);
            --accent: #00ff96;
            --danger: #ff4d4d;
        }

        body { margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: white; overflow: hidden; }

        /* Sidebar Executiva */
        #sidebar {
            position: absolute; top: 0; left: 0; bottom: 0; width: 300px;
            background: var(--sidebar-bg); backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1); z-index: 1000;
            padding: 25px; display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 14px; letter-spacing: 1px; color: var(--accent); margin: 0; font-weight: 700; text-transform: uppercase; }
        .tagline { font-size: 9px; color: #555; margin-bottom: 30px; }

        section { margin-bottom: 25px; }
        h2 { font-size: 11px; text-transform: uppercase; color: #888; margin-bottom: 12px; border-bottom: 1px solid #222; padding-bottom: 5px; }

        /* Estilo dos Filtros e Selects */
        select, button {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #333;
            background: #111; color: white; font-size: 13px; cursor: pointer; transition: 0.3s;
        }
        select:hover, button:hover { border-color: var(--accent); }

        /* Card de KPI */
        .kpi-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        .stat-val { font-weight: bold; color: var(--accent); font-family: monospace; font-size: 14px; }

        .export-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: auto; font-weight: 600; text-transform: uppercase; }
        .export-btn:hover { background: var(--accent); color: black; }

        #graph-container { width: 100vw; height: 100vh; }
        
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg);
            display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 12px; letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">SINCRONIZANDO COM GOOGLE SHEETS...</div>

    <aside id="sidebar">
        <h1>Gestão PPC e Force-Directed Graph</h1>
        <div class="tagline">Boundless Vision Analytical Tools</div>

        <section>
            <h2>Visualização por Equipe</h2>
            <select id="teamFilter" onchange="updateView()">
                <option value="todos">Todos os Trabalhos</option>
                <option value="cofragem">Equipe Cofragem</option>
                <option value="ferros">Equipe Ferragem</option>
                <option value="pedreiro">Equipe Pedreiro</option>
                <option value="eletrica">Equipe Elétrica</option>
                <option value="pintura">Equipe Pintura</option>
                <option value="gesso">Equipe Gesso</option>
            </select>
        </section>

        <section id="details">
            <h2>Inspeção de Unidade</h2>
            <div class="kpi-card">
                <div id="node-name" style="font-weight: bold; margin-bottom: 10px; font-size: 14px;">Selecione no Gráfico</div>
                <div class="stat-row"><span>Produtividade (PPC):</span> <span class="stat-val" id="node-ppc">--</span></div>
                <div class="stat-row"><span>Taxa de Erro:</span> <span class="stat-val" id="node-rework" style="color:var(--danger)">--</span></div>
                <div id="node-obs" style="font-size: 10px; color: #666; margin-top: 10px; font-style: italic;"></div>
            </div>
        </section>

        <button class="export-btn" onclick="exportData()">Exportar Auditoria Semanal</button>
    </aside>

    <div id="graph-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph"></script>

    <script>
        // --- CONFIGURAÇÃO: COLOQUE SEUS LINKS CSV ABAIXO ---
        const URL_PROFS = 'LINK_CSV_PAGINA_PROFISSIONAIS';
        const URL_LINKS = 'LINK_CSV_PAGINA_CONEXOES';

        let gData = { nodes: [], links: [] };
        const colors = { 
            gestao: '#9c27b0', 
            ferros: '#00ff96', 
            cofragem: '#ff4d4d', 
            pedreiro: '#ff9800', 
            eletrica: '#ffeb3b', 
            apoio: '#2196f3' 
        };

        const Graph = ForceGraph3D()(document.getElementById('graph-container'))
            .backgroundColor('#05070a')
            .nodeColor(n => colors[n.Equipe] || '#ffffff')
            .nodeLabel(n => `<div style="padding: 5px; background: rgba(0,0,0,0.8); border: 1px solid ${colors[n.Equipe]}"><b>${n.Nome}</b><br>${n.Função}</div>`)
            .nodeVal(n => (parseInt(n['PPC (%)']) || 50) / 4) // Tamanho baseado no PPC
            .linkWidth(1)
            .linkColor(() => 'rgba(255,255,255,0.1)')
            .linkDirectionalParticles(2)
            .linkDirectionalParticleSpeed(0.005)
            .onNodeClick(node => {
                // Zoom Suave
                const distance = 150;
                const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                Graph.cameraPosition({ x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, node, 1000);
                
                // Detalhes na Sidebar
                document.getElementById('node-name').innerText = node.Nome;
                document.getElementById('node-ppc').innerText = node['PPC (%)'] + '%';
                document.getElementById('node-rework').innerText = node['Retrabalho (%)'] + '%';
                document.getElementById('node-obs').innerText = node.Observação || '';
            });

        async function init() {
            try {
                const profs = await fetchCSV(URL_PROFS);
                const links = await fetchCSV(URL_LINKS);

                gData.nodes = profs.filter(n => n.ID); // Limpa linhas vazias
                gData.links = links.filter(l => l['Origem (ID)']).map(l => ({ 
                    source: l['Origem (ID)'], 
                    target: l['Destino (ID)'] 
                }));

                Graph.graphData(gData);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                document.getElementById('loading').innerHTML = "<span style='color:red'>ERRO DE CONEXÃO.</span><br>Certifique-se de que os links CSV estão corretos e públicos.";
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true, header: true, complete: (res) => resolve(res.data), error: reject
                });
            });
        }

        function updateView() {
            const team = document.getElementById('teamFilter').value;
            if(team === 'todos') {
                Graph.graphData(gData);
            } else {
                const filteredNodes = gData.nodes.filter(n => n.Equipe === team || n.Equipe === 'gestao');
                const nodeIds = filteredNodes.map(n => n.ID);
                const filteredLinks = gData.links.filter(l => 
                    nodeIds.includes(typeof l.source === 'object' ? l.source.ID : l.source) && 
                    nodeIds.includes(typeof l.target === 'object' ? l.target.ID : l.target)
                );
                Graph.graphData({ nodes: filteredNodes, links: filteredLinks });
            }
        }

        function exportData() {
            let content = "RELATÓRIO DE AUDITORIA - CASA ESTORIL\n";
            content += "--------------------------------------\n\n";
            gData.nodes.forEach(n => {
                content += `NOME: ${n.Nome} [${n.Equipe}]\n`;
                content += `PPC: ${n['PPC (%)']}% | RETRABALHO: ${n['Retrabalho (%)']}%\n`;
                content += `NOTAS: ${n.Observação || 'Sem observações'}\n`;
                content += "--------------------------------------\n";
            });
            const blob = new Blob([content], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Auditoria_Estoril_${new Date().toLocaleDateString()}.txt`;
            a.click();
        }

        init();
    </script>
</body>
</html>
